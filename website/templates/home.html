{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<h1 class="text-center">My Notes</h1>

<!-- Message for empty list -->
{% if user.notes|length == 0 %}
<div class="alert alert-info text-center" role="alert">
  ✨ You don't have any notes yet. Add your first note below!
</div>
{% endif %}

<!-- Notes list -->
<ul class="list-group list-group-flush" id="notes">
  {% for note in user.notes %}
  <li class="list-group-item note-item" data-note-id="{{ note.id }}">
    <!-- Note content (editable on double-click) -->
    <div class="note-content" ondblclick="enableEdit({{ note.id }})">
      {{ note.data }}
    </div>

    <!-- Note date  -->
    <small class="text-muted d-block mt-1">
      <i class="fa fa-calendar"></i> {{ note.date.strftime('%Y-%m-%d %H:%M') }}
    </small>

    <!-- Action buttons -->
    <div class="note-actions mt-2">
      <!-- Edit Button -->
      <button type="button" class="btn btn-sm btn-outline-primary"
              onclick="enableEdit({{ note.id }})">
        <i class="fa fa-edit"></i> Edit
      </button>

      <!-- Delete Button -->
      <button type="button" class="btn btn-sm btn-outline-danger ml-1"
              onclick="confirmDelete({{ note.id }})">
        <i class="fa fa-trash"></i> Delete
      </button>
    </div>

    <!-- Edit form (hidden initially) -->
    <div class="edit-form mt-2" id="edit-form-{{ note.id }}" style="display: none;">
      <textarea class="form-control edit-textarea"
                id="edit-textarea-{{ note.id }}">{{ note.data }}</textarea>
      <div class="mt-1">
        <button type="button" class="btn btn-sm btn-success"
                onclick="saveEdit({{ note.id }})">
          <i class="fa fa-save"></i> Save
        </button>
        <button type="button" class="btn btn-sm btn-secondary ml-1"
                onclick="cancelEdit({{ note.id }})">
          <i class="fa fa-times"></i> Cancel
        </button>
      </div>
    </div>
  </li>
  {% endfor %}
</ul>

<!-- Form for adding new note -->
<form method="POST" class="mt-4">
  <div class="form-group">
    <label for="note"><strong>Add a new note:</strong></label>
    <textarea name="note" id="note" class="form-control"
              rows="4" placeholder="Write your note here..."
              oninput="updateCharCounter(this)"></textarea>
    <small id="charCounter" class="text-muted">
      Characters: <span id="charCount">0</span>/10000
    </small>
  </div>
  <div class="text-center">
    <button type="submit" class="btn btn-primary">
      <i class="fa fa-plus"></i> Add Note
    </button>
    <button type="button" class="btn btn-secondary" onclick="clearTextarea()">
      <i class="fa fa-eraser"></i> Clear
    </button>
  </div>
</form>

<!-- Delete confirmation modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this note? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
  // Global variable for note to delete
  let noteToDelete = null;

  // Function for confirmed deletion
  function confirmDelete(noteId) {
    noteToDelete = noteId;
    $('#deleteModal').modal('show');
  }

  // Event for confirmation button in modal
  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (noteToDelete) {
      fetch("/delete-note", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ noteId: noteToDelete }),
      }).then((response) => {
        if (response.ok) {
          window.location.href = "/";
        } else {
          alert('Error deleting note.');
        }
      }).catch(error => {
        console.error('Error:', error);
        alert('An error occurred.');
      });
    }
    $('#deleteModal').modal('hide');
  });

  // Functions for editing
  function enableEdit(noteId) {
    const noteItem = document.querySelector(`.note-item[data-note-id="${noteId}"]`);
    if (!noteItem) return;

    // Hide original content
    noteItem.querySelector('.note-content').style.display = 'none';

    // Hide action buttons
    const noteActions = noteItem.querySelector('.note-actions');
    if (noteActions) noteActions.style.display = 'none';

    // Show edit form
    document.getElementById(`edit-form-${noteId}`).style.display = 'block';

    // Focus on textarea and select all text
    const textarea = document.getElementById(`edit-textarea-${noteId}`);
    textarea.focus();
    textarea.select();
  }

  function cancelEdit(noteId) {
    const noteItem = document.querySelector(`.note-item[data-note-id="${noteId}"]`);
    if (!noteItem) return;

    // Show original content
    noteItem.querySelector('.note-content').style.display = 'block';

    // Show action buttons
    const noteActions = noteItem.querySelector('.note-actions');
    if (noteActions) noteActions.style.display = 'block';

    // Hide edit form
    document.getElementById(`edit-form-${noteId}`).style.display = 'none';
  }

  function saveEdit(noteId) {
    const textarea = document.getElementById(`edit-textarea-${noteId}`);
    if (!textarea) return;

    const newData = textarea.value.trim();

    if (!newData) {
      alert('Note cannot be empty!');
      textarea.focus();
      return;
    }

    if (newData.length > 10000) {
      alert('Note is too long! Maximum 10000 characters.');
      return;
    }

    // Send edit request to server
    fetch("/edit-note", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        noteId: noteId,
        newData: newData
      }),
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Server error');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // Update displayed content
        const noteContent = document.querySelector(`.note-item[data-note-id="${noteId}"] .note-content`);
        if (noteContent) {
          noteContent.textContent = newData;
        }

        // Update date (if returned)
        if (data.newDate) {
          const dateElement = document.querySelector(`.note-item[data-note-id="${noteId}"] .text-muted`);
          if (dateElement) {
            dateElement.innerHTML = `<i class="fa fa-calendar"></i> ${data.newDate}`;
          }
        }

        // Back to normal view
        cancelEdit(noteId);

        // Success message
        showNotification('✅ Note updated successfully!', 'success');
      } else {
        alert('Error: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while saving the note.');
    });
  }

  // Function for character counter
  function updateCharCounter(textarea) {
    if (!textarea) return;

    const charCount = textarea.value.length;
    const charCountSpan = document.getElementById('charCount');
    if (charCountSpan) {
      charCountSpan.textContent = charCount;
    }

    // Change color if approaching limit
    if (charCountSpan) {
      if (charCount > 9500) {
        charCountSpan.style.color = 'red';
        charCountSpan.style.fontWeight = 'bold';
      } else if (charCount > 8000) {
        charCountSpan.style.color = 'orange';
      } else {
        charCountSpan.style.color = 'inherit';
        charCountSpan.style.fontWeight = 'normal';
      }
    }
  }

  // Function to clear textarea
  function clearTextarea() {
    const textarea = document.getElementById('note');
    if (textarea) {
      textarea.value = '';
      updateCharCounter(textarea);
      textarea.focus();
    }
  }

  // Function to show notifications
  function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-info';

    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
      ${message}
      <button type="button" class="close" data-dismiss="alert">
        <span>&times;</span>
      </button>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 3 seconds
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Initialize counter on page load
  document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('note');
    if (textarea) {
      updateCharCounter(textarea);
    }
  });
</script>
{% endblock %}
